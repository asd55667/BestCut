<script lang="ts" setup>
import { ResourceItem } from '@/logic/resource';
import { isVideo, isPicture, isAudio } from '@/utils/resource';

import type { PropType } from 'vue';
import {
  PlusCircleFilled,
  DownloadOutlined,
  LoadingOutlined,
  FileImageOutlined,
  StarFilled,
  // StarOutlined,
} from '@ant-design/icons-vue';
import _ from 'lodash-es';

import { usePreviewStore } from '@/store/preview';
import { useTrackStore } from '@/store/track';

import { CanvasId } from '@/settings/playerSetting';
import { addFavorite, removeFavorite } from './useResource';

// const emit = defineEmits(['checked', 'usable']);
const props = defineProps({
  // usable: {
  //   type: Boolean,
  //   default: false,
  // },
  // showAdd: {
  //   type: Boolean,
  //   default: false,
  // },
  // favorite: {
  //   type: Boolean,
  //   default: false,
  // },
  referenced: {
    type: Boolean,
    default: false,
  },
  offline: {
    type: Boolean,
    default: false,
  },
  resource: {
    type: Object as PropType<ResourceItem>,
    default: {},
  },
});

const checked = $computed(() => props.resource.checked);
const usable = $computed(() => props.resource.usable);
// const isMask = computed(() => Boolean(useAttrs().draggable));

const previewStore = usePreviewStore();
const ratio = computed(() => previewStore.ratio);

const onChecked = () => {
  // checked.value = !checked.value;
  checked ? addFavorite(props.resource) : removeFavorite(props.resource);
};

// watch(
//   () => props.resource.checked,
//   () => {
//     checked.value = props.resource.checked;
//   }
// );
// watch(
//   () => props.resource.usable,
//   () => {
//     usable.value = props.resource.usable;
//   }
// );

const trackStore = useTrackStore();
const add2Track = () => {
  const track = props.resource.toTrack();
  if (trackStore.calcWidth) track.width = trackStore.calcWidth(track);
  trackStore.addTrack(track);
};

const isLoading = ref(false);
const resourceRef = ref<HTMLElement | null>(null);
const play = (e: MouseEvent) => {
  const fn = (e: MouseEvent) => {
    trackStore.setResource(props.resource);
    // if (usable.value) {
    if (usable) {
      if (previewStore.player.active && previewStore.player.id === CanvasId) {
        if (!resourceRef.value) return;
        const left = resourceRef.value?.getBoundingClientRect().left || 0;
        const width = parseInt(getComputedStyle(resourceRef.value).width);
        const w = e.pageX - left - scrollX;
        const ratio = w / width;
        previewStore.jumpTo(ratio);
      } else previewStore.mount({ id: CanvasId, url: props.resource.src || '' });
      return;
    } else {
      isLoading.value = true;
      const download = new Promise((resolve, reject) => {
        setTimeout(() => {
          resolve('success');
          reject('error');
        }, 500);
      });
      download
        .then((res) => {
          console.log(res);
          // usable.value = true;
          // download(props.resource);
          play(e);
        })
        .catch((err) => {
          trackStore.setResource(undefined);
          console.log(err);
        })
        .then(() => {
          isLoading.value = false;
        });
    }
  };
  _.debounce(fn, 300)(e);
};

let isOver = $ref(false);
</script>

<template>
  <div
    :class="[
      'resource-box group relative rounded-md overflow-hidden',
      'w-full h-full bg-#070709',
      resource.active ? 'border-solid border-2px border-[aqua]' : '',
    ]"
    ref="resourceRef"
    @click="play"
  >
    <div
      v-if="resource.active"
      class="timeline-locator absolute rounded-md h-full w-px bg-yellow-500 top-0 z-10"
      :style="{ left: `${ratio}%` }"
    />

    <div class="resource-content overflow-hidden absolute h-full w-full">
      <div v-if="isAudio(resource)" class="h-full flex items-center">
        <img class="rounded-md h-5/6 w-2/5 ml-2 mr-1" draggable="false" :src="resource.thumbnail" />

        <div class="text-xs flex flex-col justify-between h-5/6">
          <div>
            <div text="#999">{{ resource.album }}</div>
            <div text="#474747">{{ resource.author }}</div>
          </div>
          <div v-if="resource.album && resource.author" text="#474747">
            {{ resource.duration }}
          </div>
        </div>
      </div>

      <div
        v-else
        class="h-full w-full rounded-md"
        @pointerover="isOver = true"
        @pointerleave="isOver = false"
      >
        <img
          class="h-full w-full"
          draggable="false"
          :src="isOver && !isVideo(resource) ? resource.src : resource.thumbnail"
        />
      </div>
    </div>

    <!-- tl referenced -->
    <div v-if="referenced && offline" class="absolute top-1 left-1" bg="[rgb(255,255,255,0.3)]">
      <div>已添加</div>
    </div>

    <div class="absolute top-1 right-1">
      <FileImageOutlined v-if="isPicture(resource)" />
      <div v-if="isVideo(resource) || (isAudio(resource) && !resource.album && !resource.author)">
        {{ resource.duration }}
      </div>
    </div>

    <!-- br icons  -->
    <StarFilled
      v-if="resource.favorite"
      :class="[resource.checked ? 'text-yellow-400' : '', 'favorite absolute bottom-1 right-5']"
      @click.stop="onChecked"
    />

    <PlusCircleFilled
      v-if="usable"
      :class="[resource.showAdd ? '' : 'hidden', 'absolute bottom-1 right-1']"
      group-hover="text-[aqua] block"
      @click.stop="add2Track"
    />

    <DownloadOutlined v-if="!usable && !isLoading" class="download absolute bottom-1 right-1" />
    <LoadingOutlined v-if="!usable && isLoading" class="downloading absolute bottom-1 right-1" />
  </div>
</template>
